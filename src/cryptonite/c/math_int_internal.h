/*
 * Copyright (c) 2016 PrivatBank IT <acsk@privatbank.ua>. All rights reserved.
 * Redistribution and modifications are permitted subject to BSD license.
 */

#ifndef CRYPTONITE_MATH_INT_H
#define CRYPTONITE_MATH_INT_H

#include <stdbool.h>

#include "word_internal.h"
#include "prng.h"

#define WORD_MASK (word_t)(-1)
#define MAX_WORD (dword_t)((dword_t)WORD_MASK + 1)

#ifdef  __cplusplus
extern "C" {
#endif

typedef struct Dword_st {
    word_t lo;
    word_t hi;
} Dword;

/**
 * –ü–µ—Ä–µ–≤—ñ—Ä—è—î —Ä–∞–≤–µ–Ω—Å—Ç–≤–æ –Ω—É–ª—é –±–æ–ª—å—à–æ–≥–æ —Ü–µ–ª–æ–≥–æ —á–∏—Å–ª–∞.
 *
 * @param a –≤–µ–ª–∏–∫–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
 *
 * @return true - —á–∏—Å–ª–æ —Ä–∞–≤–Ω–æ –Ω—É–ª—é, false - —á–∏—Å–ª–æ –Ω–µ—Ä–∞–≤–Ω–æ –Ω—É–ª—é
 */
bool int_is_zero(const WordArray *a);

/**
 * –ü–µ—Ä–µ–≤—ñ—Ä—è—î —Ä–∞–≤–µ–Ω—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü–µ –±–æ–ª—å—à–æ–≥–æ —Ü–µ–ª–æ–≥–æ —á–∏—Å–ª–∞.
 *
 * @param a –≤–µ–ª–∏–∫–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
 *
 * @return true - —á–∏—Å–ª–æ —Ä–∞–≤–Ω–æ –µ–¥–∏–Ω–∏—Ü–µ, false - —á–∏—Å–ª–æ –Ω–µ—Ä–∞–≤–Ω–æ –µ–¥–∏–Ω–∏—Ü–µ
 */
bool int_is_one(const WordArray *a);

/**
 * –ü–µ—Ä–µ–≤—ñ—Ä—è—î —Ä–∞–≤–µ–Ω—Å—Ç–≤–æ –¥–≤—É—Ö –±–æ–ª—å—à–∏—Ö —Ü–µ–ª—ã—Ö —á–∏—Å–µ–ª.
 *
 * @param a –≤–µ–ª–∏–∫–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
 * @param b –≤–µ–ª–∏–∫–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
 *
 * @return true - —á–∏—Å–ª–∞ —Ä–∞–≤–Ω—ã, false - —á–∏—Å–ª–∞ –Ω–µ —Ä–∞–≤–Ω—ã
 */
bool int_equals(const WordArray *a, const WordArray *b);

/**
 * –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –¥–≤–∞ –±–æ–ª—å—à–∏—Ö —Ü–µ–ª—ã—Ö —á–∏—Å–ª–∞.
 *
 * @param a –≤–µ–ª–∏–∫–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
 * @param b –≤–µ–ª–∏–∫–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
 *
 * @return 0 - —è–∫—â–æ a = b, -1 - —è–∫—â–æ a < b, 1 - —è–∫—â–æ a > b
 */
int int_cmp(const WordArray *a, const WordArray *b);

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç —Å—É–º–º—É –¥–≤—É—Ö –±–æ–ª—å—à–∏—Ö —Ü–µ–ª—ã—Ö —á–∏—Å–µ–ª.
 * out = a + b.
 *
 * @param a –≤–µ–ª–∏–∫–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –¥–ª–∏–Ω–æ–π n
 * @param b –≤–µ–ª–∏–∫–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –¥–ª–∏–Ω–æ–π n
 * @param out –±—É—Ñ–µ—Ä –¥–ª—è —Å—É–º–º—ã –¥–≤—É—Ö –±–æ–ª—å—à–∏—Ö —Ü–µ–ª—ã—Ö —á–∏—Å–µ–ª –¥–ª–∏–Ω–æ–π n
 *
 * @return –ø–µ—Ä–µ–Ω–æ—Å –ø–æ—Å–ª–µ —Å–ª–æ–∂–µ–Ω–∏—è: 0 –∞–±–æ 1
 */
word_t int_add(const WordArray *a, const WordArray *b, WordArray *out);

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç —Ä–∞–∑–Ω–æ—Å—Ç—å –¥–≤—É—Ö –±–æ–ª—å—à–∏—Ö —Ü–µ–ª—ã—Ö —á–∏—Å–µ–ª.
 * out = a - b.
 *
 * @param a –≤–µ–ª–∏–∫–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –¥–ª–∏–Ω–æ–π n
 * @param b –≤–µ–ª–∏–∫–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –¥–ª–∏–Ω–æ–π n
 * @param out –±—É—Ñ–µ—Ä –¥–ª—è —Ä–∞–∑–Ω–æ—Å—Ç–∏ –¥–≤—É—Ö –±–æ–ª—å—à–∏—Ö —Ü–µ–ª—ã—Ö —á–∏—Å–µ–ª –¥–ª–∏–Ω–æ–π n
 *
 * @return –∑–∞–π–º –ø–æ—Å–ª–µ –≤—ã—á–∏—Ç–∞–Ω–∏—è: 0 –∞–±–æ -1
 */
int int_sub(const WordArray *a, const WordArray *b, WordArray *out);

/**
 * –ø–æ–≤–µ—Ä—Ç–∞—î –¥–æ–≤–∂–∏–Ω—É –±–æ–ª—å—à–æ–≥–æ —Ü–µ–ª–æ–≥–æ —á–∏—Å–ª–∞ —É —Å–ª–æ–≤–∞—Ö –±–µ–∑ –≤–µ–¥—É—â–∏—Ö –Ω—É–ª–µ–π.
 *
 * @param a –≤–µ–ª–∏–∫–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
 *
 * @return –¥–æ–≤–∂–∏–Ω–∞ –±–æ–ª—å—à–æ–≥–æ —Ü–µ–ª–æ–≥–æ —á–∏—Å–ª–∞ —É —Å–ª–æ–≤–∞—Ö –±–µ–∑ –≤–µ–¥—É—â–∏—Ö –Ω—É–ª–µ–π
 */
size_t int_word_len(const WordArray *a);

/**
 * –ø–æ–≤–µ—Ä—Ç–∞—î –¥–æ–≤–∂–∏–Ω—É —É –±—ñ—Ç–∞—Ö –±–æ–ª—å—à–æ–≥–æ —Ü–µ–ª–æ–≥–æ —á–∏—Å–ª–∞.
 *
 * @param a –≤–µ–ª–∏–∫–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
 *
 * @return –¥–æ–≤–∂–∏–Ω–∞ –±–æ–ª—å—à–æ–≥–æ —Ü–µ–ª–æ–≥–æ —É –±—ñ—Ç–∞—Ö
 */
size_t int_bit_len(const WordArray *a);

/**
 * –í–∏–∫–æ–Ω—É—î —É—Å–µ—á–µ–Ω–∏–µ –±–æ–ª—å—à–æ–≥–æ —Ü–µ–ª–æ–≥–æ —á–∏—Å–ª–∞ –¥–æ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ —á–∏—Å–ª–∞ –±—ñ—Ç.
 *
 * @param a –≤–µ–ª–∏–∫–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
 * @param bit_len —á–∏—Å–ª–æ –æ—Å—Ç–∞–≤–ª—è–µ–º—ã—Ö –±—ñ—Ç
 *
 * @return –∫–æ–¥ –ø–æ–º–∏–ª–∫–∏
 */
void int_truncate(WordArray *a, size_t bit_len);

/**
 * –ø–æ–≤–µ—Ä—Ç–∞—î –∑–∞–¥–∞–Ω–Ω—ã–π –±—ñ—Ç –±–æ–ª—å—à–æ–≥–æ —Ü–µ–ª–æ–≥–æ —á–∏—Å–ª–∞.
 *
 * @param a –≤–µ–ª–∏–∫–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
 * @param bit_num –Ω–æ–º–µ—Ä –±—ñ—Ç–∞
 *
 * @return –∑–∞–¥–∞–Ω–Ω—ã–π –±—ñ—Ç —á–∏—Å–ª–∞
 */
int int_get_bit(const WordArray *a, size_t bit_num);

/**
 * –°–¥–≤–∏–≥–∞–µ—Ç –≤–µ–ª–∏–∫–µ —Ü–µ–ª–æ–µ –Ω–∞ –∑–∞–¥–∞–Ω–Ω–æ–µ —á–∏—Å–ª–æ –±—ñ—Ç –≤–ª–µ–≤–æ.
 *
 * @param a –≤–µ–ª–∏–∫–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
 * @param shift –≤–µ–ª–∏—á–∏–Ω–∞ —Å–¥–≤–∏–≥–∞ —É –±—ñ—Ç–∞—Ö
 * @param out –±—É—Ñ–µ—Ä –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–¥–≤–∏–≥–∞
 */
void int_lshift(const WordArray *a, size_t shift, WordArray *out);

/**
 * –°–¥–≤–∏–≥–∞–µ—Ç –≤–µ–ª–∏–∫–µ —Ü–µ–ª–æ–µ –Ω–∞ –∑–∞–¥–∞–Ω–Ω–æ–µ —á–∏—Å–ª–æ –±—ñ—Ç –≤–ø—Ä–∞–≤–æ.
 *
 * @param a_hi —Å—Ç–∞—Ä—à–µ–µ —Å–ª–æ–≤–æ–≤—ñ–¥"a"
 * @param a –≤–µ–ª–∏–∫–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
 * @param shift –≤–µ–ª–∏—á–∏–Ω–∞ —Å–¥–≤–∏–≥–∞ —É –±—ñ—Ç–∞—Ö
 * @param out –±—É—Ñ–µ—Ä –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–¥–≤–∏–≥–∞
 */
void int_rshift(word_t a_hi, const WordArray *a, size_t shift, WordArray *out);

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –¥–≤—É—Ö –±–æ–ª—å—à–∏—Ö —Ü–µ–ª—ã—Ö —á–∏—Å–µ–ª.
 *
 * @param a –ø–µ—Ä–≤–æ–µ –≤–µ–ª–∏–∫–µ —á–∏—Å–ª–æ –¥–ª–∏–Ω–æ–π n
 * @param b –≤—Ç–æ—Ä–æ–µ –≤–µ–ª–∏–∫–µ —á–∏—Å–ª–æ –¥–ª–∏–Ω–æ–π n
 * @param out –±—É—Ñ–µ—Ä –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –¥–ª–∏–Ω—ã 2n
 */
void int_mul(const WordArray *a, const WordArray *b, WordArray *out);

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –∫–≤–æ–¥—Ä–∞—Ç –±–æ–ª—å—à–æ–≥–æ —Ü–µ–ª–æ–≥–æ —á–∏—Å–µ–ª–∞.
 *
 * @param a –ø–µ—Ä–≤–æ–µ –≤–µ–ª–∏–∫–µ —á–∏—Å–ª–æ –¥–ª–∏–Ω–æ–π n
 * @param out –±—É—Ñ–µ—Ä –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –¥–ª–∏–Ω—ã 2n
 */
void int_sqr(const WordArray *a, WordArray *out);

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç —á–∞—Å—Ç–Ω–æ–µ —ñ –æ—Å—Ç–∞—Ç–æ–∫–≤—ñ–¥–¥–µ–ª–µ–Ω–∏—è –±–æ–ª—å—à–∏—Ö —Ü–µ–ª—ã—Ö —á–∏—Å–µ–ª.
 * a = q * b + r
 *
 * @param a –¥–µ–ª–∏–º–æ–µ –¥–ª–∏–Ω—ã 2n
 * @param b –¥–µ–ª–∏—Ç–µ–ª—å –¥–ª–∏–Ω—ã n
 * @param q –±—É—Ñ–µ—Ä –¥–ª—è —á–∞—Å—Ç–Ω–æ–≥–æ –¥–ª–∏–Ω—ã 2n –∞–±–æ NULL
 * @param r –±—É—Ñ–µ—Ä –¥–ª—è –æ—Å—Ç–∞—Ç–∫–∞ –¥–ª–∏–Ω—ã n –∞–±–æ NULL
 */
void int_div(const WordArray *a, const WordArray *b, WordArray *q, WordArray *r);

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç —Ü–µ–ª—É—é —á–∞—Å—Ç—å –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–≥–æ –∫–æ—Ä–Ω—è.
 * –?—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–ª–≥–æ—Ä–∏—Ç–º –ù—å—é—Ç–æ–Ω–∞.
 *
 * @param in –±–æ–ª—å—à–æ–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
 * @param out —Ü–µ–ª—É—é —á–∞—Å—Ç—å –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–≥–æ –∫–æ—Ä–Ω—è –æ—Ç in
 */
void int_sqrt(const WordArray *in, WordArray *out);

int int_rand(PrngCtx *prng, const WordArray *in, WordArray *out);
int int_prand(const WordArray *in, WordArray *out);

int int_is_prime(WordArray *a, bool *is_prime);

void factorial(int n, WordArray *fac);

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç a * b / c.
 *
 * –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —á—Ç–æ–±—ã b <= c.
 *
 * @param a –±–æ–ª—å—à–æ–µ —Ü–µ–ª–æ–µ –¥–ª–∏–Ω—ã n
 * @param b —Ü–µ–ª–æ–µ
 * @param c —Ü–µ–ª–æ–µ
 * @param n —Ä–∞–∑–º–µ—Ä a –≤ —Å–ª–æ–≤–∞—Ö
 * @param abc –º–∞—Å—Å–∏–≤ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –¥–ª–∏–Ω—ã n
 *
 * @return –∫–æ–¥ –æ—à–∏–±–∫–∏ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏
 */
int int_mult_and_div(const WordArray *a, word_t b, word_t c, int n, WordArray *abc);

int int_get_naf(const WordArray *in, int width, int **out);

int int_gen_prime(const size_t bits, PrngCtx *prng, WordArray **out);

#ifdef  __cplusplus
}
#endif

#endif
